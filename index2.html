<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multiple Scratch Cards</title>
    <script src="https://cdn.jsdelivr.net/npm/scratchcard-js@1.5.5/build/scratchcard.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: row;
      gap: 20px;
    }
    .test {
      width: 245px;
      height: 200px;
      background: red;
      position: relative;
      z-index: 3;
    }
    .test img {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: contain;
      z-index: -1;
    }
  </style>
  <body>
    <div id="appendDivs"></div>
    <script>
      let containerAppended = false;
      let prize = "safasf";
      function addNewDivContainer() {
        if (!containerAppended) {
          // cardsShow.play();
          let htmlStructure = `
        <div class="_scrathContainer _apDiv _hR">

          <div class="_scratchCardParent">
            ${Array.from(
              { length: 3 },
              (_, i) => `
              <div class="frame_scratch">
                <div class="${"_scratch" + "" + (i + 1)} _scratchCard" id=${
                "jsContainer" + "" + (i + 1)
              }>
              <div class="prizeScratch"></div>
               </div>
              </div>
            `
            ).join("")}
          </div>
        </div>
      `;
          $("#appendDivs").append(htmlStructure);
          containerAppended = true;
          addScrath();
        } else {
          console.log("Container already appended");
        }
      }

      addNewDivContainer();

      let _percentFixed;

      function addScrath() {
        console.log("loaded Scratch Script");

        const completionStatus = {
          jsContainer1: false,
          jsContainer2: false,
          jsContainer3: false,
        };

        // console.log(trueContainers, "trueContainers");

        // console.log(falseContainers, "falseContainers");
        function createScratchCard(
          containerId,
          imageForwardSrc,
          imageBackgroundSrc
        ) {
          const _containerBox = document.getElementById(containerId);
          console.log(_containerBox, "sas");
          let percentValue = 50;
          console.log(_containerBox, "each containerId");
          const sc = new ScratchCard(_containerBox, {
            scratchType: SCRATCH_TYPE.BRUSH,
            containerWidth: _containerBox.offsetWidth,
            containerHeight: _containerBox.offsetHeight,
            imageForwardSrc: imageForwardSrc,
            imageBackgroundSrc: imageBackgroundSrc,
            htmlBackground: "", // for percent
            percentToFinish: percentValue,
            clearZoneRadius: 0, //for line
            nPoints: 0, //for spray
            pointSize: 0,
            brushSrc: "./png/brush.webp",
            callback: function () {
              let percent = sc.getPercent();
              _percentFixed = percent.toFixed(2);

              completionStatus[containerId] = true;
              if (completionStatus[containerId]) {
                const trueContainers = Object.values(completionStatus).filter(
                  (status) => status
                );
                console.log(trueContainers, " trueContainers ");
                const sumOfPercentages = trueContainers.reduce(
                  (sum, containerId) => {
                    return sum + Math.floor(parseFloat(_percentFixed));
                  },
                  0
                );
                console.log(
                  sumOfPercentages,
                  " sumOfPercentages ",
                  (sumOfPercentages / 2, " sumOfPercentages ")
                );
                const allAtPercentValue = trueContainers.every(
                  (containerId) => {
                    const containerPercent = Math.floor(
                      parseFloat(_percentFixed)
                    ); // Use the same _percentFixed for all containers
                    console.log(
                      containerPercent >= percentValue,
                      "containerPercent >= percentValue"
                    );
                    return containerPercent >= percentValue;
                  }
                );
                console.log(
                  sumOfPercentages >= percentValue / 2,
                  "allAtPercentValue"
                );
                if (
                  trueContainers.length === 2 &&
                  (allAtPercentValue || sumOfPercentages / 2 >= percentValue)
                ) {
                  console.log(percentValue, ":sadasfa");
                  console.log(sumOfPercentages / 2, ":sadasfa");
                  // Trigger alerts and set pointerEvents
                  $("._scratchCard").css("pointerEvents", "none");
                  setTimeout(function () {
                    alert(
                      `Exactly two cards are done with ${Math.floor(
                        parseFloat(_percentFixed)
                      )} value completion each!`
                    );
                  }, 1000);
                }
              }
            },
          });

          sc.init()
            .then(() => {
              sc.canvas.addEventListener("scratch.move", () => {
                let percent = sc.getPercent();
                _percentFixed = percent.toFixed(0);
                if (!completionStatus[containerId] && _percentFixed >= 0) {
                  completionStatus[containerId] = true;
                  console.log(completionStatus[containerId]);

                  const trueContainerss = [];
                  Object.keys(completionStatus).forEach((containerId) => {
                    if (completionStatus[containerId]) {
                      trueContainerss.push(containerId);
                      console.log(
                        `Container ID: ${containerId}, Value: ${completionStatus[containerId]}`
                      );

                      // let textAppend = $(`#${containerId} .prizeScratch`);
                      let textAppend = $(`#${containerId} .prizeScratch`);

                      // Get a random unused prize using the function
                      const selectedPrize = getRandomUnusedPrize();

                      // Set the text using the randomly selected prize
                      textAppend.text(selectedPrize);
                    }
                  });

                  if (trueContainerss.length === 2) {
                    const remainingContainerId = Object.keys(
                      completionStatus
                    ).find((id) => !completionStatus[id]);
                    console.log(remainingContainerId);
                    if (remainingContainerId) {
                      $(`#${remainingContainerId}`).css(
                        "pointer-events",
                        "none"
                      );
                    }

                    console.log(
                      "Two containers reached 50% or more! No more scratching allowed. percent >= 0.1",
                      _percentFixed
                    );
                  }
                }
              });
            })
            .catch((error) => {
              console.error("Error initializing scratch card:", error);
            });
        }
        const containerIds = ["jsContainer1", "jsContainer2", "jsContainer3"];

        containerIds.forEach((id) => {
          createScratchCard(
            id,
            "./png/elements/unscratched.webp",
            "./png/elements/scratched.webp"
          );
        });
        console.log("test");
      }
      // Outside of your function, declare an array to keep track of used prizes
      const usedPrizes = [];

      // Function to get a random unused prize
      function getRandomUnusedPrize() {
        // Array of possible prizes
        const possiblePrizes = ["Prize 1", "Prize 2", "Prize 3", "Prize 4"];

        // Filter out used prizes
        const remainingPrizes = possiblePrizes.filter(
          (prize) => !usedPrizes.includes(prize)
        );

        // Check if there are remaining prizes
        if (remainingPrizes.length > 0) {
          // Get a random index from the remaining prizes
          const randomIndex = Math.floor(
            Math.random() * remainingPrizes.length
          );

          // Get the randomly selected prize
          const selectedPrize = remainingPrizes[randomIndex];

          // Add the selected prize to the used prizes array
          usedPrizes.push(selectedPrize);

          return selectedPrize;
        } else {
          // Handle the case when all prizes have been used
          return "No more prizes";
        }
      }

      // let textAppend = $(`#${containerId} .prizeScratch`);
      //                 if (containerId === "jsContainer1") {
      //                   textAppend.text("Prize 1");
      //                 } else if (containerId === "jsContainer2") {
      //                   textAppend.text("Prize 2");
      //                 } else if (containerId === "jsContainer3") {
      //                   textAppend.text("Prize 3");
      //                 }  no random
    </script>
  </body>
</html>
